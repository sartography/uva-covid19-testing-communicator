<!-- Main content -->
<div class="main-content">
  <!-- Top navbar -->
  <nav class="navbar navbar-top navbar-expand-md navbar-dark" id="navbar-main">
    <div class="container-fluid">
      <!-- Brand -->
      <a class="h4 mb-0 text-white text-uppercase d-none d-lg-inline-block" href="./index.html">UVA Communicator
        Dashboard</a>
    </div>
  </nav>

  <!-- Header -->
  {% include 'includes/top-stats.html' %}

  <!-- Page content -->
  <div class="container-fluid mt--7">
    <div class="row">
      <div class="col-xl-8 mb-5 mb-xl-0">
        <div class="card bg-gradient-default shadow">
          <div class="card-header bg-transparent">
            <div class="row align-items-center">
              <div class="col">
                <h6 class="text-uppercase text-light ls-1 mb-1">Overview</h6>
                <h2 id="chart-title" class="text-white mb-0">Location Activity</h2>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Chart  -->
            <div class="chart">
              <canvas id="data-chart" class="chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>


      <div class="col-xl-4">
        <div class="card shadow">
          <form action="{{ action }}" method="post" id="pageForm">
            {{ form.csrf_token() }}
            <div class="card-header border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0">Search</h3>
                </div>
                <div class="col text-right">
                  <button class="btn btn-sm btn-primary">Search Today</button>
                </div>
                <div class="col text-right">
                  <button type="submit" class="btn btn-sm btn-primary">Run Search</button>
                </div>
              </div>
            </div>

            <div class="table-responsive">

              <!-- Projects table -->
              <table class="table align-items-center table-flush">
                <tbody>
                  {% for field in form if field.name != "csrf_token" %}
                  <tr>

                    <div class="form-field {{ field.widget.input_type }}">
                      <td>
                        <div class="form-field-label">{{ field.label() }}:</div>
                      </td>
                      <td>
                        {% if field.type == "date" %}
                        <input name="{{field.name}}" />
                        {%else%}
                        <div class="form-field-input">{{ field }}</div>

                        {% for error in field.errors %}
                        <div class="form-field-error">{{ error }}</div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    </td>
                  </tr>
                  {% endfor %}
                  <script>
                    $('.datepicker').datepicker({
                      showButtonPanel: true,
                      localToday: new Date(),    // This option determines the highlighted today date
                      format: 'yyyy-mm-dd',
                      todayHighlight: true,
                    });
                  </script>
                </tbody>
              </table>
            </div>
          </form>
        </div>
      </div>

    </div>
    <div class="row mt-5">
      <div class="col mb-5 mb-xl-0">
        <div class="card shadow">
          <div class="card-header border-0">
            <div class="row align-items-center">
              <div class="col">
                <h3 class="mb-0">Records to be processed</h3>
              </div>
              <div class="col text-right">
                <button type="submit" href="#!" class="btn btn-sm btn-primary">Download all</a>
              </div>
            </div>
          </div>

          <div class="card-body row">
            <div class="chart col">
              <canvas id="week-chart" class="chart-canvas"></canvas>
            </div>
            <div class="chart col">
              <canvas id="time-chart" class="chart-canvas"></canvas>
            </div>
          </div>
        </div>

      </div>
    </div>

      <div class="row mt-2">
        <div class="col mb-5 mb-xl-0">
          <div class="card shadow">
            <div class="card-header border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0">Records to be processed</h3>
                </div>
                <div class="col text-right">
                  <button type="submit" href="#!" class="btn btn-sm btn-primary">Download all</a>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <!-- Projects table -->
              {{ table }}
            </div>
            <div class="row justify-content-center">
              {{ pagination.links }}
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  </form>

  <script>
    var location_data = JSON.parse('{{ location_data | tojson | safe}}');
    var station_data = JSON.parse('{{ station_data | tojson | safe}}');

    var ctx = document.getElementById('data-chart').getContext('2d');
    var ctx2 = document.getElementById('week-chart').getContext('2d');
    var ctx3 = document.getElementById('time-chart').getContext('2d');
    var timeFormat = 'YYYY-MM-DD h:mm:ss.SSS';

    new Chart(ctx2, {
    type: 'horizontalBar',
    data: {
      labels: ["Africa", "Asia", "Europe", "Latin America", "North America"],
      datasets: [
        {
          label: "Population (millions)",
          backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
          data: [2478,5267,734,784,433]
        }
      ]
    },
    options: {

      responsive: true,
        maintainAspectRatio: false,
      legend: { display: false 
      },
      title: {
        display: true,
        text: 'Predicted world population (millions) in 2050'
      }
    }
});
new Chart(ctx3, {
    type: 'horizontalBar',
    data: {
      labels: ["Africa", "Asia", "Europe", "Latin America", "North America"],
      datasets: [
        {
          label: "Population (millions)",
          backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
          data: [2478,5267,734,784,433]
        }
      ]
    },
    options: {

      responsive: true,
        maintainAspectRatio: false,
      legend: { display: false 
      },
      title: {
        display: true,
        text: 'Predicted world population (millions) in 2050'
      }
    }
});
    /////////Main Chart/////////
    var chart = new Chart(ctx, {
      // The type of chart we want to create
      type: 'line',
      data: location_data,

      // Configuration options go here
      options: {
        responsive: true,
        maintainAspectRatio: false,
        title: {
          display: false,
        },
        legend: {
          display: true,
          position: "right",
          onClick: location_legend,
          labels: {
            usePointStyle: true,
            fontColor: '#FFFFFF',
            fontSize: 15,
            padding: 20,
            fontStyle: 'bold'
          }
        },
        scales: {
          xAxes: [{
            type: "time",
            time: {
              format: timeFormat,
              tooltipFormat: 'll'
            },
            scaleLabel: {
              display: true,
              labelString: 'Date'
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: false,
            }
          }]
        }
      }
    }
    );

    function station_legend(e, legendItem) {
      chart.config.data = location_data;
      chart.config.options.legend.onClick = location_legend;
      $('#chart-title').text("Location Activity");
      chart.update();
    };

    function location_legend(e, legendItem) {
      $('#chart-title').text("Station Activity @ " + chart.data.datasets[legendItem.datasetIndex].label);
      chart.config.data = station_data[legendItem.datasetIndex];
      chart.config.options.legend.onClick = station_legend;
      chart.update();
    };
  </script>
  <script>

    var auto_refresh = setInterval(
      function () {
        submitform();
      }, 30000);

    function submitform() {
      $("#pageForm").submit();
    }
  </script>